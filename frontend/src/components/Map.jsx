// src/components/Map.jsx
import React, { useRef, useEffect, useState } from 'react';
import { Stage, Layer, Path, Text, Label, Tag } from 'react-konva';
import './Map.css';
import { Height } from '@mui/icons-material';

// Función auxiliar para obtener color (o definirlo en App.jsx y pasarlo)
const getPlayerColor = (playerId, players) => {
  const player = players.find(p => p.id === playerId);
  return player ? player.color : '#CCCCCC'; // Gris por defecto (neutral)
};

const placeholderTerritories = [
  { id: 'arg', name: 'Argentina', ownerPlayerId: 'p1', armies: 5, adjacentTerritoryIds: ['bra', 'per'], pathData: 'M 396.25,495.5 C 396.375,497.25 396.5,498.5 395.875,498.625 C 395.25,498.75 394,499.875 393.875,501.625 C 393.75,503.375 390.5,504.25 390.5,504.25 C 390.5,504.25 388.375,505.75 388.625,506.75 C 388.875,507.75 393.625,507 393.625,507.625 C 393.625,508.25 392.875,512.75 393.375,512.875 C 393.875,513 397.125,511.875 397.625,512.5 C 398.125,513.125 397,517 397.25,517.375 C 397.5,517.75 400.375,519.875 401.03125,519.28125 C 399.625,519.625 396.375,521.125 397,522 C 397.625,522.875 398.5,523.125 397,523.5 C 395.5,523.875 395.75,523.75 394.25,524 C 392.75,524.25 393,524.125 391.375,524.5 C 389.75,524.875 389.5,525.375 388.5,525.5 C 387.5,525.625 387,525.375 386.375,525.375 C 385.75,525.375 385.25,525.375 385.25,526 C 385.25,526.625 385.125,526.75 385.75,527.25 C 386.375,527.75 388.125,528.25 388.25,528.75 C 388.375,529.25 388.375,529.625 388.375,530.5 C 388.375,531.375 388.5,531.5 389,531.625 C 389.5,531.75 389.625,531.875 389.75,532.375 C 389.875,532.875 388.5,534.625 387.75,535.125 C 387,535.625 386.375,536.25 384.625,536.375 C 382.875,536.5 383.25,536.25 382.125,536.875 C 381,537.5 381,537.625 379.75,537.625 C 378.5,537.625 378.125,537.625 376.875,537.875 C 375.625,538.125 374.75,538.375 374.75,538.375 C 374.75,538.375 375.25,539.125 375.375,539.875 C 375.5,540.625 376.125,540.75 375.625,541.875 C 375.125,543 374.25,543.5 373.875,544 C 373.5,544.5 373.5,544.25 373.5,545.25 L 370.875,545.625 C 370.875,545.625 370,544.875 369.75,546 C 369.5,547.125 370.75,548.125 370.75,548.125 C 370.75,548.125 369,550.75 369.25,551.375 C 369.5,552 370.125,553 369.875,553.5 C 369.625,554 369.75,554.25 369.125,554.75 C 368.5,555.25 369,555.75 368.625,556.25 C 368.25,556.75 367.875,557.5 367,557.875 C 366.125,558.25 365.875,558.875 365.875,558.875 L 365.25,560 C 365.25,560 364.75,560.625 365.375,561.375 C 366,562.125 366.625,561.625 366.25,563 C 365.875,564.375 366,564.75 366,564.75 C 366,564.75 367.25,563.375 367.125,567.125 C 367,570.875 366.375,571.75 366.375,571.75 C 366.375,571.75 365.75,571.625 366,572.75 C 366.25,573.875 366.75,574.875 366.125,575.5 C 365.5,576.125 365.625,575.125 364.625,577.125 C 363.625,579.125 364.625,581.875 365.25,582.5 C 365.875,583.125 366.375,583.25 366.25,584.5 C 366.125,585.75 365.5,585.875 366,586.75 C 366.5,587.625 368.125,588.25 368.375,589.125 C 368.625,590 368.125,590.625 368.625,591.25 C 369.125,591.875 369.75,592.375 369.75,592.375 C 369.75,592.375 369.5,593.375 369.5,594.5 C 369.5,595.625 369,595.5 369,596.5 C 369,597.5 369,598.75 369.5,597.5 C 370,596.25 369.875,596.25 370.375,595.75 C 370.875,595.25 372.5,595.25 373,595.25 C 373.5,595.25 374,594.5 374.875,594.875 C 375.75,595.25 375.875,594.875 376.375,596.125 C 376.875,597.375 376.625,597.625 377.625,597.875 C 378.625,598.125 379.5,598 380.5,598 C 381.5,598 381.75,597.25 382,598.375 C 382.25,599.5 383.75,599.875 382.25,600.375 C 380.75,600.875 380.5,600.375 379,600.875 C 377.5,601.375 377.5,601.375 377,601.5 C 376.5,601.625 376.5,602 375.625,602.375 C 374.75,602.75 375.25,603.125 373.625,602.75 C 372,602.375 372.625,602.875 371.5,602.125 C 370.375,601.375 369.875,601 369.875,600.5 C 369.875,600 369.125,599.5 369.125,599.5 L 366.25,597 C 366.25,597 366,597 364.875,597 C 363.75,597 363.625,597 362.875,597 C 362.125,597 361.625,596.375 361.625,596.375 L 359.875,596.4375 C 359.875,596.4375 359.4375,596 359.6875,595.4375 C 359.9375,594.875 359.9375,594.875 359.625,594.8125 C 359.3125,594.75 358.4375,594.6875 357.875,594.5 C 357.3125,594.3125 357.875,593.5 357.75,593.25 C 357.625,593 356.4375,593 355.8125,592.9375 C 355.1875,592.875 354.3125,592.5625 353.8125,591.9375 C 353.3125,591.3125 353.4375,591.125 352.375,590.25 C 351.3125,589.375 351.625,589.25 350.6875,588.9375 C 349.75,588.625 349.4375,588.6875 349.25,587.9375 C 349.0625,587.1875 348.3125,587.0625 348,586.3125 C 347.6875,585.5625 348,585.0625 347.125,584.5 C 346.25,583.9375 346.0625,584.375 345.9375,583.1875 C 345.8125,582 346.125,581.4375 345.8125,580.8125 C 345.5,580.1875 345.6875,580.6875 345.1875,579.9375 C 344.6875,579.1875 344.4375,579.0625 344.25,578.1875 C 344.0625,577.3125 344.0625,576.875 343.75,576.3125 C 343.4375,575.75 342.875,575.5 342.8125,574.875 C 342.75,574.25 342.75,574 342.75,573.4375 C 342.75,572.875 342.9375,572.4375 342.625,571.1875 C 342.3125,569.9375 342.5,569.625 341.875,568.875 C 341.25,568.125 341.1875,568.625 340.6875,567 C 340.1875,565.375 339.625,565.125 339.9375,564.3125 C 340.25,563.5 340.4375,563.375 340.5,562.75 C 340.5625,562.125 340.9375,562.25 341,561.375 C 341.0625,560.5 341.0625,560.75 341.0625,559.5625 C 341.0625,558.375 340.3125,559.875 341.1875,556.625 C 342.0625,553.375 342.0625,553.5 342.125,552.75 C 342.1875,552 343.375,551.875 342.9375,550.5625 C 342.5,549.25 342.25,549.25 342.375,548.375 C 342.5,547.5 343,547.125 342.875,546.6875 C 342.75,546.25 342.9375,546.4375 342.75,545.9375 C 342.5625,545.4375 343.25,545.6875 342.4375,545.0625 C 341.625,544.4375 341.375,544.5625 341.25,543.625 C 341.125,542.6875 341.125,541.9375 341.1875,538.25 C 341.25,534.5625 341,534.3125 341.625,533.25 C 342.25,532.1875 342.5625,532.0625 342.5625,531.1875 C 342.5625,530.3125 343.0625,529.1875 342.6875,528.125 C 342.3125,527.0625 342,526.9375 342.375,526.3125 C 342.75,525.6875 343.0625,525.6875 343.0625,524.9375 C 343.0625,524.1875 343.0625,525.25 343.125,523.625 C 343.1875,522 342.6875,523.1875 343.3125,521.0625 C 343.9375,518.9375 344.1875,516.8125 344.25,515.75 C 344.3125,514.6875 344.375,514.375 344.0625,513.75 C 343.75,513.125 343.3125,510.125 343.3125,509.125 C 343.3125,508.125 343.5,508.375 343.75,507.375 C 344,506.375 344.0625,506.1875 344,505.875 C 343.9375,505.5625 344,505.25 344.1875,504.4375 C 344.375,503.625 344,501.9375 344.6875,500.1875 C 345.375,498.4375 345.5625,499.125 345.375,497.875 C 345.1875,496.625 343.75,494.625 344.1875,493.25 C 344.625,491.875 345.0625,492.125 345,490.3125 C 344.9375,488.5 344.75,486.0625 345.1875,485.0625 C 345.625,484.0625 345.875,480.625 345.6875,479.8125 L 345.875,479.75 C 346.25,476.875 344.75,474.375 344.75,474.375 C 344.75,474.375 346.25,472.75 347.125,472.5 C 348,472.25 348.125,474.125 347.875,475.125 C 347.625,476.125 348,477.125 349.125,478.25 C 350.25,479.375 351.5,480.625 352,481.5 C 352.5,482.375 353.75,483.125 354,484.125 C 354.25,485.125 354.625,486.125 355.875,487.125 C 357.125,488.125 357.875,487 358.125,486.25 C 358.375,485.5 358,483.75 358.25,482 C 358.5,480.25 360.75,482.25 360.75,482.25 C 360.75,482.25 361.625,484.125 362,484.75 C 362.375,485.375 364,485.125 364.75,484.375 C 365.5,483.625 366,483.75 366.5,483.75 C 367,483.75 368,484.75 369.75,484.5 C 371.5,484.25 371.625,484.125 373.125,485.5 C 374.625,486.875 373.375,487.625 374.75,488.5 C 376.125,489.375 376.125,488.5 377,488.875 C 377.875,489.25 377.375,490.375 378.75,491.25 C 380.125,492.125 383.75,491.375 385,491.875 C 386.25,492.375 385,493.5 385,494.375 C 385,495.25 385,497.625 384.375,497.875 C 383.75,498.125 382.875,499.875 383,501.25 C 383.125,502.625 386.375,501.25 387.75,500.625 C 389.125,500 389.75,500.125 391.125,498.875 C 392.5,497.625 396.25,495.5 396.25,495.5 z' }, // Cuadrado
  { id: 'bra', name: 'Brasil', ownerPlayerId: 'p2', armies: 3, adjacentTerritoryIds: ['arg', 'per', 'ven'], pathData: 'M 404.375,403.625 C 404.375,403.625 400.04566,407.19876 399.51533,408.25942 C 398.985,409.32008 398.63145,411.61818 397.39401,411.79496 C 396.15657,411.97174 388.73195,412.32529 388.73195,412.32529 C 388.73195,412.32529 389.08551,414.44661 388.02485,414.44661 C 386.96419,414.44661 376.53436,414.09306 376.53436,414.09306 L 375.12015,409.85041 C 375.12015,409.85041 373.88271,410.7343 373.70593,408.96653 C 373.52916,407.19876 373.52916,404.37034 373.52916,404.37034 C 373.52916,404.37034 370.87751,405.78455 369.28652,406.31488 C 367.69553,406.84521 366.28131,409.49686 364.8671,408.96653 C 363.45289,408.4362 362.74578,406.66843 362.39223,408.08265 C 362.03867,409.49686 362.569,413.7395 361.50834,414.09306 C 360.44768,414.44661 360.09413,413.82789 359.21025,414.88855 C 358.32636,415.94921 355.93988,416.21438 355.23277,415.59566 C 354.52566,414.97694 353.99533,414.26983 353.19984,414.00467 C 352.40434,413.7395 351.9624,413.29756 351.07852,413.20917 C 350.19463,413.12078 350.01786,412.67884 349.31075,413.47434 C 348.60364,414.26983 347.10104,415.59566 346.83588,416.30276 C 346.57071,417.00987 345.1565,419.57313 345.51005,420.5454 C 345.8636,421.51768 347.27782,421.25251 347.27782,423.02028 C 347.27782,424.78805 346.74749,425.67193 345.77522,425.93709 C 344.80294,426.20226 339.94159,427.79325 339.94159,427.79325 C 339.94159,427.79325 335.875,427.75 335.75,428.375 C 335.625,429 335.875,432.875 334.875,433.625 C 333.875,434.375 331.125,434 331,435 C 330.875,436 328.875,436.625 329.625,438 C 330.375,439.375 331.75,440.625 332.75,440.625 C 333.75,440.625 335,440.75 335.125,441.75 C 335.25,442.75 338.75,442.875 340.125,443.625 C 341.5,444.375 345,442.5 344.75,444.625 C 344.5,446.75 340.875,447.125 340.625,448.5 C 340.375,449.875 340.25,452.875 343,452.75 C 345.75,452.625 348.25,450.75 350.125,450.375 C 352,450 353.875,450 354.375,449.5 C 354.875,449 355.25,447.75 356.25,447.625 C 357.25,447.5 359.625,448.625 360.375,449.875 C 361.125,451.125 361.25,452.25 362.75,452.375 C 364.25,452.5 363.75,453.375 364.875,453.875 C 366,454.375 367,453.875 368,454.5 C 369,455.125 369,457.25 370.625,457.25 C 372.25,457.25 374.5,456.125 375.125,457.375 C 375.75,458.625 376.375,460.375 377.125,461.125 C 377.875,461.875 377.375,462.875 377.625,463.625 C 377.875,464.375 379.375,464.5 380.5,465.375 C 381.625,466.25 381.75,466.75 382.125,468.5 C 382.5,470.25 383.375,470.25 384.125,471.75 C 384.875,473.25 386.125,476.5 385.875,477.625 C 385.625,478.75 384.875,480.125 386.375,481 C 387.875,481.875 388.5,482.375 389.375,483.75 C 390.25,485.125 390.875,484.625 391.5,485.125 C 392.125,485.625 392.5,487.5 392.875,490.125 C 393.25,492.75 396.125,493.75 396.25,495.5 C 396.375,497.25 396.5,498.5 395.875,498.625 C 395.25,498.75 394,499.875 393.875,501.625 C 393.75,503.375 390.5,504.25 390.5,504.25 C 390.5,504.25 388.375,505.75 388.625,506.75 C 388.875,507.75 393.625,507 393.625,507.625 C 393.625,508.25 392.875,512.75 393.375,512.875 C 393.875,513 397.125,511.875 397.625,512.5 C 398.125,513.125 397,517 397.25,517.375 C 397.5,517.75 400.375,519.875 401.0625,519.3125 C 402.375,518.875 401.625,518.75 401.875,518 C 402.125,517.25 402.125,517.375 402.75,516.5 C 403.375,515.625 403,515.625 403.25,514.875 C 403.5,514.125 403.875,513.5 404.375,513 C 404.875,512.5 405.125,512.375 405.375,511.625 C 405.625,510.875 405.5,510.5 405.625,509.25 C 405.75,508 407.25,507.875 408.625,507.375 C 410,506.875 409.875,505.375 410,504.125 C 410.125,502.875 409.625,503.75 409.625,502.375 C 409.625,501 409.5,500.5 409.375,499.125 C 409.25,497.75 409.5,498.625 410.125,498 C 410.75,497.375 410.75,494.625 412.25,491.5 C 413.75,488.375 424.75,487.5 425.25,487.375 C 425.75,487.25 428.625,486.25 429,485.75 C 429.375,485.25 430.625,484.125 431.625,483.625 C 432.625,483.125 432,482.25 432.25,481.125 C 432.5,480 432.75,480.375 433.375,480.125 C 434,479.875 433.875,479.125 434.5,478.25 C 435.125,477.375 434.5,476.5 434.875,475.75 C 435.25,475 436.375,474.75 437.25,474.375 C 438.125,474 437.625,472.75 438.375,472 C 439.125,471.25 438.375,468.625 438.375,467 C 438.375,465.375 438.375,465.25 439.125,464.25 C 439.875,463.25 438.875,461.25 438.875,461.25 L 439.125,459.5 C 439.125,459.5 438.75,457.5 439,456.5 C 439.25,455.5 440.25,455 441.75,454 C 443.25,453 442.25,450.75 442.25,450.75 L 442.25,449 C 442.25,449 444.5,448 446.25,448 C 448,448 448,445.5 449.5,444 C 451,442.5 450.25,441 450.5,439.75 C 450.75,440.25 450.25,439 449.875,437.875 C 449.5,436.75 449.75,436.25 449.5,434.5 C 449.25,432.75 448.25,432 447.25,431 C 446.25,430 444.875,430.25 444,430 C 443.125,429.75 442.625,428.125 441.75,427.875 C 440.875,427.625 437.5,425.25 435.625,425 C 433.75,424.75 433.625,424.875 432.75,423.875 C 431.875,422.875 431.375,423.5 430.75,423.5 C 430.125,423.5 429.125,424 428.375,423.5 C 427.625,423 427.25,423.25 426.125,423.25 C 425,423.25 424,422.875 423.5,422 C 423,421.125 423,421 422.25,420.625 C 421.5,420.25 420.625,420.5 419.875,420.125 C 419.125,419.75 418.25,419.375 417.5,419.25 C 416.75,419.125 415.875,419.375 415.125,419.25 C 414.375,419.125 412.625,418.75 412,418.75 C 411.375,418.75 409.5,419.125 408.625,419.125 C 407.75,419.125 406.25,417.625 405,417.125 C 403.75,416.625 406.125,417 408,414.75 C 409.875,412.5 407.25,411.125 406.75,410.25 C 406.25,409.375 406.125,408.625 405.375,406 C 404.625,403.375 404.375,403.625 404.375,403.625 z' }, // Cuadrado
  { id: 'per', name: 'Peru', ownerPlayerId: 'p1', armies: 2, adjacentTerritoryIds: ['arg', 'bra', 'ven'], pathData: 'M 347.125,472.5 C 348,472.25 348.125,474.125 347.875,475.125 C 347.625,476.125 348,477.125 349.125,478.25 C 350.25,479.375 351.5,480.625 352,481.5 C 352.5,482.375 353.75,483.125 354,484.125 C 354.25,485.125 354.625,486.125 355.875,487.125 C 357.125,488.125 357.875,487 358.125,486.25 C 358.375,485.5 358,483.75 358.25,482 C 358.5,480.25 360.75,482.25 360.75,482.25 C 360.75,482.25 361.625,484.125 362,484.75 C 362.375,485.375 364,485.125 364.75,484.375 C 365.5,483.625 366,483.75 366.5,483.75 C 367,483.75 368,484.75 369.75,484.5 C 371.5,484.25 371.625,484.125 373.125,485.5 C 374.625,486.875 373.375,487.625 374.75,488.5 C 376.125,489.375 376.125,488.5 377,488.875 C 377.875,489.25 377.375,490.375 378.75,491.25 C 380.125,492.125 383.75,491.375 385,491.875 C 386.25,492.375 385,493.5 385,494.375 C 385,495.25 385,497.625 384.375,497.875 C 383.75,498.125 382.875,499.875 383,501.25 C 383.125,502.625 386.375,501.25 387.75,500.625 C 389.125,500 389.75,500.125 391.125,498.875 C 392.5,497.625 396.25,495.5 396.25,495.5 C 396.125,493.75 393.25,492.75 392.875,490.125 C 392.5,487.5 392.125,485.625 391.5,485.125 C 390.875,484.625 390.25,485.125 389.375,483.75 C 388.5,482.375 387.875,481.875 386.375,481 C 384.875,480.125 385.625,478.75 385.875,477.625 C 386.125,476.5 384.875,473.25 384.125,471.75 C 383.375,470.25 382.5,470.25 382.125,468.5 C 381.75,466.75 381.625,466.25 380.5,465.375 C 379.375,464.5 377.875,464.375 377.625,463.625 C 377.375,462.875 377.875,461.875 377.125,461.125 C 376.375,460.375 375.75,458.625 375.125,457.375 C 374.5,456.125 372.25,457.25 370.625,457.25 C 369,457.25 369,455.125 368,454.5 C 367,453.875 366,454.375 364.875,453.875 C 363.75,453.375 364.25,452.5 362.75,452.375 C 361.25,452.25 361.125,451.125 360.375,449.875 C 359.625,448.625 357.25,447.5 356.25,447.625 C 355.25,447.75 354.875,449 354.375,449.5 C 353.875,450 352,450 350.125,450.375 C 348.25,450.75 345.75,452.625 343,452.75 C 340.25,452.875 340.375,449.875 340.625,448.5 C 340.875,447.125 344.5,446.75 344.75,444.625 C 345,442.5 341.5,444.375 340.125,443.625 C 338.75,442.875 335.25,442.75 335.125,441.75 C 335,440.75 333.75,440.625 332.75,440.625 C 331.75,440.625 330.375,439.375 329.625,438 C 328.875,436.625 330.875,436 331,435 C 331.125,434 333.875,434.375 334.875,433.625 C 335.875,432.875 335.625,429 335.75,428.375 C 335.875,427.75 339.94159,427.79325 339.94159,427.79325 C 339.94159,427.79325 339.14609,425.67193 338.61576,425.1416 C 338.08543,424.61127 337.11316,424.3461 336.40605,424.16933 C 335.69894,423.99255 334.5499,422.75511 333.66601,422.8435 C 332.78213,422.93189 330.48403,422.93189 329.86531,422.22478 C 329.2466,421.51768 328.18594,420.72218 326.59495,420.63379 C 325.00395,420.5454 324.29685,421.69445 323.23619,420.01507 C 322.17553,418.3357 320.23098,416.0376 319.70065,415.94921 C 319.17032,415.86082 316.69545,415.59566 317.375,414.875 C 315.5,416.125 315.625,418.625 314.875,420.5 C 314.125,422.375 313.5,423.125 312.875,425.125 C 312.25,427.125 313.25,426.625 314,428.75 C 314.75,430.875 313.75,429.75 313.375,431 C 313,432.25 313.25,436.25 313.25,436.25 C 313.25,436.25 314.125,438.875 314.625,439.375 C 315.125,439.875 317.125,442.125 317.125,442.125 C 317.125,442.125 316.875,443.75 317.375,445.75 C 317.875,447.75 318.75,447 319.25,448 C 319.75,449 321.75,451.125 322.375,451.625 C 323,452.125 324.375,454.25 325.75,454.75 C 327.125,455.25 326.125,457.125 326,458.125 C 325.875,459.125 327.375,461.375 327.875,462.375 C 328.375,463.375 328.625,462.625 329.125,463.375 C 329.625,464.125 331,465.125 331.875,465.625 C 332.75,466.125 333.625,466.25 333.625,466.25 C 333.625,466.25 334.875,467.375 335.75,468 C 336.625,468.625 337.75,468.875 338.5,469.125 C 339.25,469.375 340.5,472.125 341.125,472.75 C 341.125,472.75 343.875,473.875 344.5,474 C 345.125,474.125 346.25,472.625 347.125,472.5 z' }, // Cuadrado
  { id: 'ven', name: 'Venezuela', ownerPlayerId: null, armies: 1, adjacentTerritoryIds: ['bra', 'per'], pathData: 'M 317.375,414.875 C 319.25,413.625 318.875,411.125 318.875,410.375 C 318.875,409.625 318.875,408.25 318.875,407.25 C 318.875,406.25 318.75,405.5 319.875,404.25 C 321,403 321.625,401.875 321.625,401.875 L 322.875,400.75 L 322.875,398.75 L 323.625,396.5 C 323.625,396.5 324.125,395.375 324.25,394.875 C 324.375,394.375 324,392.375 324,392.375 L 324.25,390.75 L 327.375,389.875 C 327.375,389.875 327.75,390.25 328.75,389.875 C 329.75,389.5 330.75,388.625 330.75,388.625 L 333,387.375 C 333,387.375 334.5,386.375 335,385.875 C 335.5,385.375 337.25,384.75 337.25,384.75 C 337.25,384.75 338.125,384.5 338.75,384.5 C 339.375,384.5 341.5,383.875 341.5,383.875 C 341.5,383.875 341.625,383.25 342.375,382.75 C 343.125,382.25 343.625,381.625 344.25,381.5 C 344.875,381.375 348.25,380.875 348.25,380.875 C 348.25,380.875 349.5,381.75 349.625,383 C 349.75,384.25 349.25,385 350.25,384.875 C 351.25,384.75 352.25,384.5 352.75,384.25 C 353.25,384 353,382.875 354.25,383.75 C 355.5,384.625 355.625,384.875 356.125,384.875 C 356.625,384.875 358,384.5 358,384.5 L 363.5,386.375 C 363.5,386.375 364.75,386.125 365.375,386 C 366,385.875 369.125,385.625 369.125,385.625 C 369.125,385.625 370.5,386 371,386.5 C 371.5,387 374.625,388.875 375.625,390.375 C 376.625,391.875 378.125,392.375 378.375,393 C 378.625,393.625 379.625,394.25 380.125,394.25 C 380.625,394.25 380.625,395.25 381.25,395.375 C 381.875,395.5 383.25,395.5 383.25,395.5 C 383.25,395.5 383.375,396 383.875,396.625 C 384.375,397.25 385.5,396 385.75,397.375 C 386,398.75 385.625,399.5 386.375,399.5 C 387.125,399.5 387.875,399 387.875,399 L 389.125,398.5 C 389.125,398.5 389.125,397.5 390.125,398.5 C 391.125,399.5 391.875,399.25 392.75,399.5 C 393.625,399.75 392.375,400.375 394.5,400.875 C 396.625,401.375 398.625,401.625 399.125,401.625 C 399.625,401.625 399.625,399.625 401.375,401.25 C 403.125,402.875 404.375,403.625 404.375,403.625 C 404.375,403.625 400.04566,407.19876 399.51533,408.25942 C 398.985,409.32008 398.63145,411.61818 397.39401,411.79496 C 396.15657,411.97174 388.73195,412.32529 388.73195,412.32529 C 388.73195,412.32529 389.08551,414.44661 388.02485,414.44661 C 386.96419,414.44661 376.53436,414.09306 376.53436,414.09306 L 375.12015,409.85041 C 375.12015,409.85041 373.88271,410.7343 373.70593,408.96653 C 373.52916,407.19876 373.52916,404.37034 373.52916,404.37034 C 373.52916,404.37034 370.87751,405.78455 369.28652,406.31488 C 367.69553,406.84521 366.28131,409.49686 364.8671,408.96653 C 363.45289,408.4362 362.74578,406.66843 362.39223,408.08265 C 362.03867,409.49686 362.569,413.7395 361.50834,414.09306 C 360.44768,414.44661 360.09413,413.82789 359.21025,414.88855 C 358.32636,415.94921 355.93988,416.21438 355.23277,415.59566 C 354.52566,414.97694 353.99533,414.26983 353.19984,414.00467 C 352.40434,413.7395 351.9624,413.29756 351.07852,413.20917 C 350.19463,413.12078 350.01786,412.67884 349.31075,413.47434 C 348.60364,414.26983 347.10104,415.59566 346.83588,416.30276 C 346.57071,417.00987 345.1565,419.57313 345.51005,420.5454 C 345.8636,421.51768 347.27782,421.25251 347.27782,423.02028 C 347.27782,424.78805 346.74749,425.67193 345.77522,425.93709 C 344.80294,426.20226 339.94159,427.79325 339.94159,427.79325 C 339.94159,427.79325 339.14609,425.67193 338.61576,425.1416 C 338.08543,424.61127 337.11316,424.3461 336.40605,424.16933 C 335.69894,423.99255 334.5499,422.75511 333.66601,422.8435 C 332.78213,422.93189 330.48403,422.93189 329.86531,422.22478 C 329.2466,421.51768 328.18594,420.72218 326.59495,420.63379 C 325.00395,420.5454 324.29685,421.69445 323.23619,420.01507 C 322.17553,418.3357 320.23098,416.0376 319.70065,415.94921 C 319.17032,415.86082 316.69545,415.59566 317.375,414.875 z' } // Cuadrado
];

function extractPointsFromPath(d) {
  // Extrae todos los números del string (soporta floats)
  const regex = /-?\d*\.?\d+/g;
  const numbers = d.match(regex).map(Number);

  // Agrupa en pares (x, y)
  const points = [];
  for (let i = 0; i < numbers.length - 1; i += 2) {
    points.push([numbers[i], numbers[i + 1]]);
  }

  return points;
}

function calculateCentroid(points) {
  if (points.length === 0) return null;

  let sumX = 0;
  let sumY = 0;

  points.forEach(([x, y]) => {
    sumX += x;
    sumY += y;
  });

  return {
    x: sumX / points.length,
    y: sumY / points.length
  };
}


function Map({
  territories = [],
  players = [],
  onTerritoryClick,
  selectedTerritoryId,
  targetTerritoryId
}) {
  const [stageSize, setStageSize] = useState({ width: 1024, height: 500 });
  const containerRef = useRef(null); //Ref para el div contenedor

  const [tooltip, setTooltip] = useState({
    visible: false,
    x: 0,
    y: 0,
    text: ''
  });

  useEffect(() => {
    const checkSize = () => {
      if (containerRef.current) {
        setStageSize({
          width: containerRef.current.offsetWidth,
          height: containerRef.current.offsetHeigth || 700
        });
      }
    };

    checkSize();

    window.addEventListener('resize', checkSize);
    return () => window.removeEventListener('resize', checkSize);
  }, []);

  const displayTerritories = territories && Object.keys(territories).length > 0 ? territories : placeholderTerritories;
  const territoriesArray = Array.isArray(displayTerritories) ? displayTerritories : Object.values(displayTerritories);
  return (
    // Contenedor para medir el tamaño disponible
    <div ref={containerRef} style={{ width: '100%', height: '100%', border: '1px solid red', position: 'relative' }}>
      <Stage width={stageSize.width} height={stageSize.height}>
        <Layer>

          {territoriesArray.map((territory) => {
            if (!territory.pathData) {
              console.warn(`Territorio ${territory.id} no tiene pathData.`);
              return null;
            }

            const isSelected = territory.id === selectedTerritoryId;
            const isTarget = territory.id === targetTerritoryId;
            const ownerColor = getPlayerColor(territory.ownerPlayerId, players);

            // const points = extractPointsFromPath(territory.pathData);
            // const centroid = calculateCentroid(points);

            return (
              <React.Fragment key={territory.id}>
                {/* Dibuja la forma del territorio */}
                <Path
                  data={territory.pathData}
                  fill={ownerColor}
                  stroke={isSelected ? 'yellow' : (isTarget ? 'red' : 'black')} // Borde según selección/target
                  strokeWidth={isSelected || isTarget ? 3 : 1}
                  opacity={0.9}
                  shadowColor="black"
                  shadowBlur={isSelected || isTarget ? 10 : 3}
                  shadowOpacity={0.5}
                  onClick={() => onTerritoryClick(territory.id)} // Evento de clic
                  onTap={() => onTerritoryClick(territory.id)} // Para móvil
                  onMouseEnter={e => {
                    // Cambiar cursor y opcionalmente resaltar
                    const stage = e.target.getStage();
                    if (stage) stage.container().style.cursor = 'pointer';
                    e.target.opacity(1); // Resaltar al pasar el mouse
                    // Podrías también usar onMouseOver/onMouseOut para mostrar un tooltip
                    const mousePos = stage.getPointerPosition();
                    setTooltip({
                      visible: true,
                      x: mousePos.x,
                      y: mousePos.y,
                      text: `ID: ${territory.id}`
                    });
                  }}
                  onMouseLeave={e => {
                    // Restaurar cursor y opacidad
                    const stage = e.target.getStage();
                    if (stage) stage.container().style.cursor = 'default';
                    e.target.opacity(0.9);
                    setTooltip({ ...tooltip, visible: false });
                  }}
                />
                {/* Dibuja el número de ejércitos */}
                {/* <Text
                  x={centroid.x.toFixed(2)}
                  y={centroid.y.toFixed(2)}
                  text={territory.armies.toString()}
                  fontSize={14}
                  fill="black"
                  stroke="black"
                  strokeWidth={0.5}
                  align="center"
                  verticalAlign="middle"
                  listening={false} // Para que no interfiera con el clic en el Path
                /> */}
                {tooltip.visible && (
                  <Label x={tooltip.x + 10} y={tooltip.y + 10}>
                    <Tag
                      fill="black"
                      pointerDirection="down"
                      pointerWidth={10}
                      pointerHeight={10}
                      lineJoin="round"
                      cornerRadius={5}

                    />
                    <Text
                      text={tooltip.text}
                      fontFamily="Calibri"
                      fontSize={16}
                      padding={5}
                      fill="white"
                    />
                  </Label>
                )}
              </React.Fragment>
            );
          })}
        </Layer>
      </Stage>
    </div>
  );
}

export default Map;